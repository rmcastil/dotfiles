#!/bin/bash

set -e

function check_variable() {
  if [ -d "$CODE" ]; then
    echo "Code points to '$CODE'"
  else
    echo "Set the CODE variable before continuing."
    exit 1
  fi
}

function link_dotfiles() {
  echo 'Linking dotfiles'
  for link in .config .gemrc .gitconfig .irbrc .paths.zsh .rspec .zshenv .zshrc; do
    if [ -L "$HOME/$link" ]; then
      echo "Link '$link' already exists"
    else
      echo "Creating link to '$link'"
      ln -s "$CODE/dotfiles/$link" .
    fi
  done
}

function install_xcode() {
  echo 'Ensure that we have xcode tools installed'
  'xcode-select --install'
}

function install_homebrew() {
  if command -v brew; then
    echo "Homebrew installed; updating:"
    brew update
  else
    echo "Installing Homebrew:"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # eval $(/opt/homebrew/bin/brew shellenv)
  fi
}

function install_things() {
  for pkg in asdf git neovim postgresql tree; do
  if brew list -1 | grep -q "^${pkg}\$"; then
    echo "Package '$pkg' is installed; updating:"
    brew upgrade "$pkg" && brew cleanup "$pkg" || true
  else
    brew install "$pkg"
  fi
done
}

function main() {
  check_variable
  link_dotfiles
  # install_xcode
  install_homebrew
  install_things
  # message to create pack directory and run mpack
  # gem install bundler solargraph
  # make sure the solargraph.yml fiile is in rails projects
}

main
